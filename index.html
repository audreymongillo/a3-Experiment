<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content=
            "width=device-width, initial-scale=1.0">
    <title>D3 : Random Number Generation - Column Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
    <style type="text/css">

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        .hidden {
            display: none;
        }
        
        /* Style for starting screen */
        #startScreen {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 16px;
            font-family: Times New Roman;
            background-color: #c7dfe2;
        }
        /* Style for the tab bar on the top of the screen */
        .top-bar {
            display: flex;
            justify-content: flex-end;
            background-color: #207d89;
            color: white;
            padding: 16px;
        }

        /* Style for the tab with "Background" and "experiment" */
        .tab {
            display: inline-block;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Adding a line between the words in the top bar because it was hard to read */
        .tab:not(:last-child) {
            border-right: 1px solid white;
        }

        /* Changing the color of the tabs when you hover over it */
        .tab:hover {
            background-color: #fff; 
            color: #207d89;
            border-radius: 15px;
        }

        /* Adding my font preferences for the Welcome font */
        #startScreen h1 {
        font-size: 40px;
        font-family: Times New Roman;
        color: #207d89;
        }

        /* Adding my font preferences for the creators font */
        #startScreen h2 {
        font-size: 24px;
        font-family: Times New Roman;
        color: #11535c;
        }

        #doneScreen {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 16px;
            font-family: Times New Roman;
            background-color: #c7dfe2;
        }

        #nameInput{
            width: 200px;
            height: 20px;
        }


        /* Style for the screen if user does not agree to do the experiment*/
        #disagreeScreen {
            display: block;
            text-align: center;
            margin-top: 50px;
            font-size: 12px;
            font-family: Arial;
        }

        /* Style the "Agree" button */
        #agreeButton {
            padding: 10px 20px;
            width: 150px;
            font-size:24px;
            font-family: Times New Roman;
            background-color: #207d89;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* Style for the "Disagree" button */
        #disagreeButton {
            padding: 10px 20px;
            width: 150px;
            font-size: 24px;
            font-family: Times New Roman;
            background-color: #207d89;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* Style for the "Next" button */
        #nextButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0277d0;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        #downloadButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0277d0;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* Style for the page displaying the graph */
        #chartholder {
            height: 600px;
            width: 600px;
            /*outline the left and bottom edges of the chart*/
            border-left: 3px solid black;
            border-bottom: 3px solid black;
            position: relative;
            display:flex;
            justify-content: flex-start;
            flex-direction: row; /*(column = stacked bar chart)*/
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .bar {
            width: 25px;
            margin-left: 3px;
            background-color: white; /* White fill for D3 bars */
            border: 3px solid black; /* Black outline for D3 bars */
            bottom: 0;
        }

        /*controls positioned horizontally at the bottom of the chart*/
        #controlsholder {
            display: flex;
            justify-content: left;
            align-items: left;
        }


    </style>
</head>
<body>
<!-- Start Screen (always shown) -->
<div id="startScreen">
    <div class="top-bar">
        <div class="tab" id="backgroundTab">Background</div>
        <div class="tab" id="experimentTab">Try Experiment</div>
    </div>
    <div id="backgroundContent" class="content hidden">
        <h2>Background on this assignment</h2>
        <p>In 1984, William Cleveland and Robert McGill published the results of several controlled experiments that pitted bar charts against pies and stacked-bar variants. Their paper (http://www.cs.ubc.ca/~tmm/courses/cpsc533c-04-spr/readings/cleveland.pdf) (http://info.slis.indiana.edu/~katy/S637-S11/cleveland84.pdf) is considered a key paper in data visualization.</p>
    </div>
    <div id="experimentContent" class="content">
        <h1>Welcome to our assignment 3 experiment!</h1>
    <h2>Creators: Audrey Mongillo, Connor Ehrensperger, and Alysha Creelman<br></h2>
    <h3><br>In this experiment, you are asked to judge what is the percent of a smaller value to a larger value in several charts.<br><br> Please enter your name below and then click "Agree" to begin.<br>Thank you! <br></h3>
        <input type="text" id="nameInput" placeholder="First Name"> <br><br>
        <button id="agreeButton">Agree</button>
    <button id="disagreeButton">Disagree</button>
    </div>
</div>

<!-- Disagree Screen (shown when user hits "Disagree") -->
<div id="disagreeScreen" style="display: none;">
    <h2>Thank you for your consideration. You may close out of this window. </h2>
</div>

<!-- Chart Screen (only shown if the user hits "Agree") -->
<div id="chartholderholder" style="display: none;">
    <div id="chartholder"></div>
    <div id="controlsholder">
        <!-- text input -->
        <input type="text" id="percentInput" placeholder="Enter the percent here">
        <button id="nextButton">Next</button>
    </div>
</div>

<div id="doneScreen" style="display: none;">
    <h2>Thank you for participating. Here are your results: </h2>
    <button id="downloadButton">Download CSV</button>
</div>

<script type="text/javascript">
    //used to make sure we are getting 20 trials for each type of chart
    let normalBarCount = 0;
    let rotateBarCount = 0;
    let stackedCount = 0;

    //keeping track of the two heights we are comparing for each round
    let index1height = 0;
    let index2height = 0;

    //what the correct answers are
    let actualPercents = new Array(60);
    //what the user input for each
    let inputPercents = new Array(60);

    //for setting each of the array values
    let totalCount = 0;
    let userID = ""

    //saves the type of chart the trial is on
    let typeArray = new Array(60);

    let trials = [];

    function finishedTest(){
        document.getElementById("doneScreen").style.display = "block";
        document.getElementById("chartholderholder").style.display = "none";
    }

   const download = function (data) {

        const blob = new Blob([data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.setAttribute('href', url)
        a.setAttribute('download', userID + '.csv');
        a.click()
    }

    const csvmaker = function (data) {

        const csvRows = [];

        const headers = Object.keys(data[0]);

        csvRows.push(headers.join(','));

        for (const row of data) {
            const values = headers.map(header => {
                const val = row[header]
                return `"${val}"`;
            });

            csvRows.push(values.join(','));
        }

        return csvRows.join('\n');
    }

    const get = async function () {
        const data = trials
        const csvdata = csvmaker(data);
        download(csvdata);
    }

    const btn = document.getElementById('downloadButton');
    btn.addEventListener('click', get);


    function generateChart() {

        //changed to 1 for testing - need to be changed back to 20
        if(normalBarCount >= 1 && rotateBarCount >= 1 && stackedCount >= 1){
            finishedTest();
        }

        // Generate new random data
        data = d3.range(10).map(function() {
            return Math.random();
        });

        let stackedBarChart = Math.random() < 1/3;
        if(stackedCount >= 20){stackedBarChart = false;}
        let minimumBarHeight = stackedBarChart? 31 : 40;
        let multiplier = stackedBarChart? 50 : 400;
        // Generate two unique random indices
        index1 = Math.floor(Math.random() * data.length);
        index2 = Math.floor(Math.random() * data.length);

        while(index1 === index2) {
            index2 = Math.floor(Math.random() * data.length);
        }

        // Remove all old circles and circle containers
        d3.select('.circleContainer').remove();
        d3.select('.circle').remove();
        for(let i = 0; i < data.length; i++) {
            d3.select('.circleContainer' + i).remove();
            d3.select('.circle' + i).remove();
        }

        // Remove the old chart
        d3.select('#chartholder').selectAll('*').remove();

        // Display a simple Column Chart using the above Random Data
        var svg = d3.select('#chartholder').selectAll('div')
            .data(data)
            .enter()
            .append('div')
            .attr('class', 'bar')
            .style('fill', '#ffffff')
            .style('height', function (d) {
                let result = (d*multiplier + minimumBarHeight) + 'px';

                return result;
            })
            .style('width', stackedBarChart? '100px' : '25px')
            .each(function(d, i) {
                // Append circles to the randomly chosen bars
                if (i === index1 || i === index2) {
                    let bar = d3.select(this);
                    let barWidth = parseInt(bar.style('width'));
                    let barHeight = d*multiplier + minimumBarHeight;
                    console.log(bar);
                    if(stackedBarChart) {
                        bar.append('svg')
                            .attr('width', barWidth)
                            .attr('height', barHeight)
                            .attr('class', 'circleContainer' + i)
                            .append('circle')
                            .attr('class', 'circle' + i)
                            .attr('r', 4)
                            .attr('cx', barWidth / 2)
                            .attr('cy', barHeight / 2)
                            .style('fill', 'black');
                            // if(index1){index1height = barHeight;}
                            // if(index2){index2height = barHeight;}
                            typeArray[totalCount] = "Stacked Bar Chart";
                    } else {
                        bar.append('svg')
                            .attr('width', barWidth)
                            .attr('height', '100%')
                            .attr('class', 'circleContainer' + i)
                            .append('circle')
                            .attr('class', 'circle' + i)
                            .attr('r', 4)
                            .attr('cx', barWidth / 2)
                            .style('fill', 'black');

                        let y =d*multiplier + minimumBarHeight;
                        console.log("d:", d*multiplier + minimumBarHeight);


                        d3.select('.circle' + i).attr('cy', y - 15);
                    }
                    //save the heights of the bars with the dots
                    if(i === index1){
                        index1height = barHeight;
                        console.log("index1height:", index1height);
                    }
                    if(i === index2){
                        index2height = barHeight;
                        console.log("index2height:", index2height);
                    }
                }
            });

        if (stackedBarChart) {
            stackedCount++;
            d3.select('#chartholder').style('flex-direction', 'column');
            d3.select('#chartholder').style('transform', 'rotate(0deg)');
            d3.select('#chartholder').style('align-items', 'center');
            d3.select('#chartholder').style('justify-content', 'flex-end');

            d3.selectAll('.bar').style('display', 'flex');
            d3.selectAll('.bar').style('justify-content', 'center');
            d3.selectAll('.bar').style('align-items', 'center');

            // set the circles to be in the middle of the bars
            for(let i = 0; i < data.length; i++) {
                d3.selectAll('.circleContainer' + i).style('display', 'flex');
                d3.selectAll('.circleContainer' + i).style('justify-content', 'center');
                d3.selectAll('.circleContainer' + i).style('align-items', 'center');
            }

        } else {
            d3.select('#chartholder').style('align-items', 'flex-end');
            d3.select('#chartholder').style('justify-content', 'flex-start');
            d3.select('#chartholder').style('flex-direction', 'row');
        }


        // Only rotate it if it's not a stacked bar chart
        if(!stackedBarChart) {
            // Randomly choose to rotate the chart or not
            let rotate = Math.random() < 0.5;
            if(rotateBarCount >= 20){rotate = false;}
            if (rotate) {
                rotateBarCount++
                d3.select('#chartholder').style('transform', 'rotate(90deg)');
                typeArray[totalCount] = "Horizontal Bar Chart";
            } else {
                if(normalBarCount >= 20){generateChart();}
                else {
                    normalBarCount++
                    d3.select('#chartholder').style('transform', 'rotate(0deg)');
                    typeArray[totalCount] = "Bar Chart";
                }
            }
        }
        //calculate the percentage
        if(index1height < index2height)
        {
            let percent = (index1height/index2height) * 100;
            actualPercents[totalCount] = Math.round(percent);
        }
        else {
            let percent = (index2height/index1height) * 100;
            actualPercents[totalCount] = Math.round(percent);
        }


    }

    // Generate the first chart
    generateChart();

    // Listener for when "Agree" button is clicked (only show chart screen)
    document.getElementById("agreeButton").addEventListener("click", function() {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("disagreeScreen").style.display = "none";
        document.getElementById("chartholderholder").style.display = "block";
        userID = document.getElementById("nameInput").value;
    });

    // Listener for when "Disagree" button is clicked (only show disagree screen)
    document.getElementById("disagreeButton").addEventListener("click", function() {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("disagreeScreen").style.display = "block";
        document.getElementById("chartholderholder").style.display = "none";
    });

    document.getElementById("nextButton").addEventListener("click", function()
    {
        //set user input for that chart in array
        inputPercents[totalCount] = document.getElementById("percentInput").value;
        var trial = {
            "Participant": userID,
            "Trial Number": totalCount + 1,
            "Graph Type": typeArray[totalCount],
            "Input Percent": inputPercents[totalCount],
            "Actual Percent": actualPercents[totalCount]
        };
        trials.push(trial);
        //clear text box value
        document.getElementById("percentInput").value = "";
        //increment array counter
        totalCount++;
        generateChart();

    });

    document.addEventListener("DOMContentLoaded", function() {
    const backgroundTab = document.getElementById("backgroundTab");
    const backgroundContent = document.getElementById("backgroundContent");
    const experimentTab = document.getElementById("experimentTab");
    const experimentContent = document.getElementById("experimentContent");

    // Listener for when 'Background' is hit in the top bar
    backgroundTab.addEventListener("click", function() {
        // Hide the experiment content
        document.getElementById("experimentContent").classList.add("hidden");
        backgroundContent.classList.remove("hidden");
    });

    // Listener for when 'experiment' is hit in the tob bar
    experimentTab.addEventListener("click", function() {
        document.getElementById("backgroundContent").classList.add("hidden");
        experimentContent.classList.remove("hidden");
    });
});


</script>
</body>
</html>